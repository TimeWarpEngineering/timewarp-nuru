# Benchmark Analysis - December 20, 2025

## Executive Summary

**Good News:** TimeWarp.Nuru.Direct (CreateEmptyBuilder) is now **2nd place** at 3.98 ms!

**Bad News:** TimeWarp.Nuru with Mediator (CreateBuilder) regressed to **last place** at 131.96 ms - a 4x regression from July 2025.

## Current Rankings

| Rank | Framework                    | Mean        | Ratio  | Memory     | Status              |
| ---- | ---------------------------- | ----------- | ------ | ---------- | ------------------- |
| 1    | ConsoleAppFramework v5       | 0.79 ms     | 1.00   | 288 B      | Baseline            |
| **2**    | **TimeWarp.Nuru.Direct**         | **3.98 ms**     | **5.03**   | **14,776 B**   | **CreateEmptyBuilder**  |
| 3    | CommandLineParser            | 10.94 ms    | 13.82  | 46,368 B   |                     |
| 4    | System.CommandLine           | 19.39 ms    | 24.50  | 15,240 B   |                     |
| 5    | CliFx                        | 23.74 ms    | 30.00  | 76,192 B   |                     |
| 6    | PowerArgs                    | 32.11 ms    | 40.57  | 77,248 B   |                     |
| 7    | McMaster.Extensions          | 38.88 ms    | 49.13  | 57,480 B   |                     |
| 8    | Cocona.Lite                  | 50.13 ms    | 63.34  | 62,528 B   |                     |
| 9    | Spectre.Console.Cli          | 57.66 ms    | 72.86  | 75,016 B   |                     |
| 10   | Cocona                       | 67.10 ms    | 84.78  | 690,240 B  |                     |
| **11**   | **TimeWarp.Nuru (Mediator)**     | **131.96 ms**   | **166.73** | **221,152 B**  | **CreateBuilder - NEEDS FIX** |

## Comparison: July 2025 vs December 2025

### Nuru (Full Builder with Mediator)

| Metric   | July 2025  | December 2025 | Change        |
| -------- | ---------- | ------------- | ------------- |
| Time     | 34.42 ms   | 131.96 ms     | **3.8x slower**   |
| Rank     | 6th        | 11th (last)   | **-5 positions**  |
| Memory   | 18,576 B   | 221,152 B     | **12x more**      |

### Nuru.Direct (Empty Builder)

| Metric   | July 2025      | December 2025 | Change        |
| -------- | -------------- | ------------- | ------------- |
| Time     | Not benchmarked | 3.98 ms       | **2nd place!**    |
| Memory   | Not benchmarked | 14,776 B      | Very efficient    |

## Performance Analysis

### What's Working Well

1. **Core parsing/routing is excellent** - Nuru.Direct at 3.98 ms proves the fundamental architecture is sound
2. **Memory efficiency for Direct** - 14.7 KB is very competitive
3. **Source generators for invokers** - The InvokerRegistry path is fast

### What's Broken

1. **Mediator/DI cold-start is catastrophic** - 131.96 ms is unacceptable
2. **Memory bloat** - 221 KB vs 14.7 KB (15x difference between Full and Direct)
3. **Regression since July** - We went backwards despite adding source generators

### Root Cause Hypothesis

The regression likely comes from:
1. **Mediator source generator initialization** - Scanning for handlers at startup
2. **DI container setup** - More services registered than before
3. **Configuration loading** - Full builder loads appsettings, etc.
4. **Extension method chain** - `UseAllExtensions()` adds overhead

### Action Items

1. **Profile CreateBuilder startup** - Where is the 130ms going?
2. **Compare July vs December code** - What changed in the DI/Mediator path?
3. **Consider lazy initialization** - Don't pay for what you don't use
4. **Optimize Mediator setup** - Can handler registration be faster?

## Direct vs Full Comparison

| Aspect        | Direct (Empty)   | Full (Mediator)  | Ratio     |
| ------------- | ---------------- | ---------------- | --------- |
| Time          | 3.98 ms          | 131.96 ms        | 33x       |
| Memory        | 14.8 KB          | 221.2 KB         | 15x       |
| Rank          | 2nd              | 11th             | -         |
| DI Container  | No               | Yes              | -         |
| Mediator      | No               | Yes              | -         |
| Configuration | No               | Yes              | -         |
| Auto-Help     | No               | Yes              | -         |

## Benchmark Configuration

- **Platform:** Linux Ubuntu 24.04.3 LTS (Noble Numbat)
- **CPU:** AMD Ryzen 9 3900X 3.79GHz, 12 cores
- **Runtime:** .NET 10.0.1, X64 RyuJIT x86-64-v3
- **Benchmark Tool:** BenchmarkDotNet v0.15.6
- **Strategy:** ColdStart (1 iteration, no warmup)
- **Toolchain:** InProcessEmitToolchain

## Recommendations

### Short Term

1. **Keep CreateEmptyBuilder** - It's our competitive showcase
2. **Investigate Full builder regression** - This is blocking Phase 3
3. **Document the trade-offs** - Users should know Direct is 33x faster

### Long Term

1. **Lazy DI initialization** - Only pay for DI when first route needs it
2. **Optimize Mediator setup** - Source gen should help, not hurt
3. **Profile-guided optimization** - Find the hot spots
4. **Consider tiered startup** - Fast path for simple commands
