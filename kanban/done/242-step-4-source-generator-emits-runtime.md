# Source generator emits runtime structures

## Parent

#239 Epic: Compile-time endpoint generation

## Description

Extend the source generator to automate Phase 2: from design-time model (`RouteDefinition`) emit the runtime C# code. This automates the manual construction from step-2.

## Context

The source generator now:
1. Parses source syntax → builds `RouteDefinition` (step-3)
2. From `RouteDefinition` → emits runtime code (this step)

The manual construction from step-2 serves as the reference for what should be emitted.

## Checklist

- [x] Generator emits runtime structure code from `RouteDefinition`
- [x] Emitted code compiles successfully
- [x] Emitted segment matchers work correctly (LiteralMatcher, IntParameterMatcher, StringParameterMatcher)
- [x] Emitted parameter extractors work correctly (TypeConverter.ToInt32, ToString, etc.)
- [x] End-to-end tests verify matching and extraction
- [x] Add Router type to generated code for command matching
- [x] `add 2 2` works via generated code ✅ **KEY DELIVERABLE**
- [ ] ~~AppB uses generated code instead of manual construction~~ → #260
- [ ] ~~Parity tests pass: AppA output == AppB output~~ → #261-#263

## Notes

### Current Progress

**Files created:**
- `sandbox/sourcegen/emitters/RuntimeCodeEmitter.cs` - emits C# from RouteDefinition
- `sandbox/sourcegen/tests/runtime-code-emitter-tests.cs` - 5 tests
- `sandbox/sourcegen/tests/end-to-end-emitter-tests.cs` - 5 tests
- `sandbox/sourcegen/tests/add-command-demo-test.cs` - 2 tests (key deliverable)

**What works:**
- Emits CompiledRoute, ISegmentMatcher, LiteralMatcher, IntParameterMatcher, StringParameterMatcher
- Emits ParameterExtractor with TypeConverter methods
- Emits Router, MatchAttempt, MatchResult for command routing
- Generated code compiles and runs correctly
- Matchers correctly match/reject input
- Extractors correctly convert string→int, string→string
- **"add 2 2" works!** Matches, extracts x=2, y=2, computes 4

**What's left:**
- Integration with dual-build AppB (handler registration mechanism)
- Parity tests comparing AppA vs AppB output

### Generated Output

The generator emits something like:
```csharp
// <auto-generated/>
internal static class GeneratedRoutes
{
    internal static readonly CompiledRoute[] All = [ ... ];
    // Pre-built matchers, extractors, etc.
}
```

### Relation to Other Tasks

After this step works for the basic case, tasks #243-#248 expand what gets generated:
- #243: Pre-sorted endpoint array
- #244: Inlined pipeline
- #245: Static services
- #246: Help text
- #247: Completion scripts
- #248: Zero-cost Build()

This step is the foundation those build on.

## Results

**Completed 2024-12-24**

### Deliverables

Core runtime code emission is working:

1. **RuntimeCodeEmitter** (`sandbox/sourcegen/emitters/RuntimeCodeEmitter.cs`)
   - Emits complete C# source from RouteDefinition
   - Generates CompiledRoute, ISegmentMatcher, LiteralMatcher, IntParameterMatcher, StringParameterMatcher
   - Generates ParameterExtractor with TypeConverter methods
   - Generates Router, MatchAttempt, MatchResult for command routing

2. **Test Coverage** (66 tests passing)
   - `runtime-code-emitter-tests.cs` - 5 tests for emission
   - `end-to-end-emitter-tests.cs` - 5 tests for matching/extraction
   - `add-command-demo-test.cs` - 2 tests demonstrating key deliverable

3. **Key Deliverable Achieved**
   - "add 2 2" works via generated code
   - Matches route, extracts x=2 and y=2, computes result 4

### Deferred to Follow-up Tasks

The remaining integration work is tracked separately:
- **#260**: Wire AppB to use generated code
- **#261-#263**: Parity tests comparing AppA vs AppB output

### Observations

The emitter provides a solid foundation for the compile-time endpoint generation epic (#239). The architecture cleanly separates concerns: design-time model building (step-3) from runtime code emission (this step).
