# V2 Generator - Core Endpoint Generation

## Parent

#239 Epic: Compile-time endpoint generation

## Description

Implement V2 generator to emit the core runtime structures (routes, matchers, extractors, router). Adapt the work from sandbox/sourcegen into the real analyzer project.

## Decisions

### V2 Uses Existing Runtime Types (2024-12-24)

**Decision**: The V2 generator emits code that **instantiates existing runtime types** from `TimeWarp.Nuru` namespace (`LiteralMatcher`, `ParameterMatcher`, `OptionMatcher`, `CompiledRoute`). It does NOT emit new type definitions.

**Why**:
- Task #243 explicitly shows the expected output using existing types
- The sandbox's custom types (`ISegmentMatcher`, `IntParameterMatcher`, etc.) were a shortcut for isolation, not an architectural decision
- Emitting new types causes CS0436 conflicts when library and consumer both have the generator

**Analysis**: See `.agent/workspace/2024-12-24T18-30-00_v2-generator-runtime-types-analysis.md`

## Checklist

- [x] Move/adapt `RuntimeCodeEmitter` from sandbox to analyzer project
- [x] Move/adapt extractors (FluentChainExtractor, DelegateAnalyzer, etc.) to analyzer project
- [x] V2 generator analyzes `Map()` fluent chains
- [x] V2 generator emits `GeneratedRoutes` using existing runtime types
- [x] Fix: Rewrite emitter to use existing types instead of generating new ones
- [x] Re-run tests with `UseNewGen=true`, track progress on passing tests
- [x] Document any tests that need V2-specific updates

## Results

**Completed 2024-12-24**

### Test Results with `UseNewGen=true`

| Phase   | Success | Failed | Notes |
|---------|---------|--------|-------|
| Compile | 150     | 1      | 1 failure unrelated to V2 (`NuruContext` not found) |
| Run     | 119     | 31     | Expected - generated routes not wired to runtime yet |

Full results: `tests/scripts/test-results-v2.md`

### What Works

1. **V2 generator runs** when `UseNewGen=true`
2. **Emits correct output** using existing runtime types:
   - `CompiledRoute` instances with `Segments`, `MessageType`, `Specificity`
   - `LiteralMatcher`, `ParameterMatcher` for route segments
   - Pre-sorted by specificity (descending)
3. **No type conflicts** - builds succeed for all projects

### Generated Output Example

```csharp
// <auto-generated/>
using TimeWarp.Nuru;

namespace TimeWarp.Nuru.Generated;

internal static class GeneratedRoutes
{
    private static readonly CompiledRoute Route_0 = new()
    {
        Segments = new RouteMatcher[]
        {
            new LiteralMatcher("add"),
            new ParameterMatcher("x", constraint: "int"),
            new ParameterMatcher("y", constraint: "int"),
        },
        MessageType = MessageType.Query,
        Specificity = 140,
    };

    internal static readonly CompiledRoute[] All = [ Route_0 ];
}
```

### Why Runtime Tests Fail

The generated `GeneratedRoutes.All` array exists but nothing uses it yet. The runtime still uses the V1 path (`NuruRouteRegistry`, `InvokerRegistry`, etc.).

**Wiring generated routes to runtime execution is Task #248** (Zero-cost Build).

### Files Modified

| File | Change |
|------|--------|
| `analyzers/emitters/runtime-code-emitter.cs` | Rewritten to use existing types, removed 250+ lines of type generation |
| `analyzers/nuru-v2-generator.cs` | Updated namespace from `TimeWarp.Nuru.V2.Generated` to `TimeWarp.Nuru.Generated` |

### Known Limitations

1. **Option parsing**: Pattern parser skips options (`--flag`, `-f`). Need to emit `OptionMatcher` instances.
2. **Handler binding**: Generated routes don't include handler invocation - that's #248's scope.
