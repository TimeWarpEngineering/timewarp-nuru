# Implement Source Generators for Reflection-Free Routing

## Description

Replace reflection-based delegate invocation with source-generated code to enable full AOT compatibility and eliminate runtime reflection. Currently, `DelegateParameterBinder` uses `DynamicInvoke` which is incompatible with AOT compilation and trimming.

## Problem Statement

- `DynamicInvoke` uses reflection at runtime
- Reflection prevents full AOT optimization
- Trimming can't determine which code paths are used
- Runtime type discovery conflicts with AOT requirements

## Requirements

- Generate compile-time code for all route invocations
- Support all current routing patterns
- Zero reflection at runtime
- Full compatibility with AOT compilation
- Maintain existing API surface

## Implementation Approach

### Source Generator Tasks

1. **Analyze AddRoute Calls**
   - Find all `AddRoute` method invocations
   - Extract route patterns and delegate signatures
   - Generate unique identifiers for each route

2. **Generate Invocation Methods**
   ```csharp
   // Generated for: app.AddRoute("add {x:int} {y:int}", (int x, int y) => ...)
   private static object? InvokeRoute_Add_Int_Int(Delegate handler, object?[] args)
   {
       var typedHandler = (Action<int, int>)handler;
       typedHandler((int)args[0], (int)args[1]);
       return null;
   }
   ```

3. **Generate Route Registry**
   ```csharp
   // Generated registry mapping routes to invocation methods
   private static readonly Dictionary<string, Func<Delegate, object?[], object?>> RouteInvokers = new()
   {
       ["add_{x:int}_{y:int}"] = InvokeRoute_Add_Int_Int,
       // ... other routes
   };
   ```

4. **Replace DynamicInvoke**
   - Modify DelegateParameterBinder to use generated invokers
   - Fall back to DynamicInvoke only in development/non-AOT scenarios

## Technical Considerations

### AOT Benefits
- Predictable performance
- Smaller binary size (trimmed reflection APIs)
- Faster startup time
- Better memory usage

### Source Generator Structure
```
TimeWarp.Nuru.SourceGenerators/
├── RouteAnalyzer.cs
├── RouteInvokerGenerator.cs
├── RouteRegistryGenerator.cs
└── Templates/
    ├── InvokerMethod.template
    └── Registry.template
```

## Examples

### Input Code
```csharp
app.AddRoute("greet {name}", (string name) => Console.WriteLine($"Hello {name}"));
app.AddRoute("add {x:int} {y:int}", (int x, int y) => Console.WriteLine(x + y));
app.AddRoute("stats {*values:double}", (double[] values) => Console.WriteLine(values.Average()));
```

### Generated Code
```csharp
// <auto-generated/>
internal static class GeneratedRouteInvokers
{
    public static object? InvokeRoute_0(Delegate handler, object?[] args)
    {
        ((Action<string>)handler)((string)args[0]);
        return null;
    }
    
    public static object? InvokeRoute_1(Delegate handler, object?[] args)
    {
        ((Action<int, int>)handler)((int)args[0], (int)args[1]);
        return null;
    }
    
    public static object? InvokeRoute_2(Delegate handler, object?[] args)
    {
        ((Action<double[]>)handler)((double[])args[0]);
        return null;
    }
}
```

## Success Criteria

- All delegate routes work without reflection
- AOT compilation produces warning-free binaries
- Performance equal to or better than direct method calls
- Source generator handles all supported parameter types
- Clear compile-time errors for unsupported scenarios

## Future Considerations

- Coordinate with martinothamar/Mediator for unified approach
- Consider incremental generators for better IDE performance
- Support for generic delegates
- Integration with trimming annotations

## Reference Implementation

The `martinothamar/Mediator` source generator provides an excellent reference for this implementation:

**Local Path:** `/home/steventcramer/worktrees/github.com/TimeWarpEngineering/martinothamar-mediator/main/src/Mediator.SourceGenerator/`

**Key Files to Study:**
- `IncrementalMediatorGenerator.cs` - Entry point using `IIncrementalGenerator`
- `Implementation/Analysis/CompilationAnalyzer.cs` - Code analysis patterns
- `Implementation/MediatorImplementationGenerator.cs` - Code generation
- `Implementation/Models/` - Data models for analyzed code
- `Implementation/resources/*.sbn-cs` - Scriban templates for code generation

**GitHub:** https://github.com/martinothamar/Mediator

## Notes

### Session Start - 2025-12-03

Starting implementation. Reference implementation available at:
`/home/steventcramer/worktrees/github.com/TimeWarpEngineering/martinothamar-mediator/main/src/Mediator.SourceGenerator/`

This task is a prerequisite for:
- Task 016: Achieve full AOT compatibility
- Task 018: Make configuration validation sample AOT compatible