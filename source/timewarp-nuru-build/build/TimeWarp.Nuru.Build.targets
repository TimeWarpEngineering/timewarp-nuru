<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- 
    TimeWarp.Nuru.Build targets
    Generates a JsonSerializerContext with [JsonSerializable] attributes for user-defined 
    return types discovered from both delegate routes and [NuruRoute] attributed classes.
    
    This runs BEFORE CoreCompile so System.Text.Json source generator can process the output.
    
    Supports two modes:
    - NuGet package: Task DLL is in build/net10.0/ relative to this file
    - Local development: Overridden by repo's Directory.Build.targets
  -->

  <!-- Default: NuGet package mode - task DLL is alongside this file -->
  <PropertyGroup>
    <_NuruBuildTaskDir Condition="'$(_NuruBuildTaskDir)' == ''">$(MSBuildThisFileDirectory)net10.0/</_NuruBuildTaskDir>
  </PropertyGroup>

  <UsingTask 
    TaskName="TimeWarp.Nuru.Build.GenerateNuruJsonContextTask" 
    AssemblyFile="$(_NuruBuildTaskDir)TimeWarp.Nuru.Build.dll" />

  <Target 
    Name="GenerateNuruJsonContext" 
    BeforeTargets="CoreCompile"
    Condition="'@(Compile)' != '' and '$(DesignTimeBuild)' != 'true'">
    
    <GenerateNuruJsonContextTask
      SourceFiles="@(Compile)"
      References="@(ReferencePath)"
      IntermediateOutputPath="$(IntermediateOutputPath)">
      <Output TaskParameter="GeneratedFiles" ItemName="_NuruGeneratedJsonContext" />
    </GenerateNuruJsonContextTask>

    <!-- Include generated file in compilation -->
    <ItemGroup Condition="'@(_NuruGeneratedJsonContext)' != ''">
      <Compile Include="@(_NuruGeneratedJsonContext)" />
    </ItemGroup>
    
    <Message 
      Text="TimeWarp.Nuru.Build: Added @(_NuruGeneratedJsonContext) to compilation" 
      Importance="low"
      Condition="'@(_NuruGeneratedJsonContext)' != ''" />
    
  </Target>

</Project>
