#!/usr/bin/dotnet --
// subcommand-app-di - Nuru DI/class-based version of Cocona's GettingStarted.SubCommandApp
#:project ../../../Source/TimeWarp.Nuru/TimeWarp.Nuru.csproj
#:package Mediator.Abstractions
#:package Mediator.SourceGenerator

using TimeWarp.Nuru;
using Mediator;
using Microsoft.Extensions.DependencyInjection;
using static System.Console;

// CLI app demonstrating sub-commands with DI/Mediator pattern
NuruApp app = new NuruAppBuilder()
    .AddDependencyInjection()
    .ConfigureServices(services => services.AddMediator())

    // Top-level commands
    .Map<HelloCommand>("hello {name|Your name} --to-upper-case,-u|Print a name converted to upper-case {toUpperCase:bool}")
    .Map<ByeCommand>("bye {name|Your name} --to-lower-case,-l|Print a name converted to lower-case {toLowerCase:bool}")

    // Sub-commands
    .Map<KonnichiwaCommand>("sub-commands konnichiwa {member}")
    .Map<SubHelloCommand>("sub-commands hello")

    // Sub-sub-commands
    .Map<FoobarCommand>("sub-commands sub-sub-commands foobar")
    .Map<PrimaryCommand>("sub-commands sub-sub-commands {value:string}")

    .AddAutoHelp()
    .Build();

return await app.RunAsync(args);

// Top-level commands
public sealed class HelloCommand : IRequest
{
    public string Name { get; set; } = string.Empty;
    public bool ToUpperCase { get; set; }

    internal sealed class Handler : IRequestHandler<HelloCommand>
    {
        public ValueTask<Unit> Handle(HelloCommand request, CancellationToken cancellationToken)
        {
            WriteLine($"Hello {(request.ToUpperCase ? request.Name.ToUpper() : request.Name)}!");
            return default;
        }
    }
}

public sealed class ByeCommand : IRequest
{
    public string Name { get; set; } = string.Empty;
    public bool ToLowerCase { get; set; }

    internal sealed class Handler : IRequestHandler<ByeCommand>
    {
        public ValueTask<Unit> Handle(ByeCommand request, CancellationToken cancellationToken)
        {
            WriteLine($"Goodbye {(request.ToLowerCase ? request.Name.ToLower() : request.Name)}!");
            return default;
        }
    }
}

// Sub-commands
public sealed class KonnichiwaCommand : IRequest
{
    public Member Member { get; set; }

    internal sealed class Handler : IRequestHandler<KonnichiwaCommand>
    {
        public ValueTask<Unit> Handle(KonnichiwaCommand request, CancellationToken cancellationToken)
        {
            WriteLine($"Konnichiwa! {request.Member}");
            return default;
        }
    }
}

public sealed class SubHelloCommand : IRequest
{
    internal sealed class Handler : IRequestHandler<SubHelloCommand>
    {
        public ValueTask<Unit> Handle(SubHelloCommand request, CancellationToken cancellationToken)
        {
            WriteLine("Hello!");
            return default;
        }
    }
}

// Sub-sub-commands
public sealed class FoobarCommand : IRequest
{
    internal sealed class Handler : IRequestHandler<FoobarCommand>
    {
        public ValueTask<Unit> Handle(FoobarCommand request, CancellationToken cancellationToken)
        {
            WriteLine("Foobar!");
            return default;
        }
    }
}

public sealed class PrimaryCommand : IRequest
{
    public string Value { get; set; } = string.Empty;

    internal sealed class Handler : IRequestHandler<PrimaryCommand>
    {
        public ValueTask<Unit> Handle(PrimaryCommand request, CancellationToken cancellationToken)
        {
            WriteLine($"value={request.Value}");
            return default;
        }
    }
}

// Enum for member parameter
public enum Member
{
    Alice,
    Karen
}
